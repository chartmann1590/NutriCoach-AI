{% extends "base.html" %}

{% block title %}Photo Food Log - NutriCoach{% endblock %}
{% block page_title %}Photo Food Log{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="mb-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
                    Upload Food Photo
                </h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    Take or upload a photo of your food and let AI identify the items and nutrition.
                </p>
            </div>

            <!-- Upload Area -->
            <div class="mb-6">
                <div id="upload-area" 
                     class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-colors cursor-pointer"
                     ondrop="handleDrop(event)" 
                     ondragover="handleDragOver(event)"
                     onclick="document.getElementById('photo-input').click()">
                    <input type="file" 
                           id="photo-input" 
                           accept="image/*" 
                           class="hidden"
                           onchange="handleFileSelect(event)">
                    
                    <div id="upload-content">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                            Upload a photo
                        </h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                            Drag and drop an image here, or click to select
                        </p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            PNG, JPG, GIF up to 8MB
                        </p>
                    </div>
                </div>
            </div>

            <!-- Preview Area -->
            <div id="preview-area" class="hidden mb-6">
                <img id="preview-image" 
                     class="w-full h-64 object-cover rounded-lg mb-4" 
                     alt="Food preview">
                <div class="flex justify-center space-x-4">
                    <button onclick="uploadPhoto()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-magic mr-2"></i>
                        Analyze Photo
                    </button>
                    <button onclick="clearPhoto()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-times mr-2"></i>
                        Clear
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="hidden text-center py-8">
                <div class="inline-flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-lg">Analyzing your photo...</span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    This may take a few seconds while AI identifies the food items.
                </p>
            </div>

            <!-- Results -->
            <div id="results-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-md font-medium text-gray-900 dark:text-gray-100">
                        AI Identified Foods
                    </h4>
                    <button onclick="quickAddAllToLog()" 
                            id="add-all-btn"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>
                        Quick Add All
                    </button>
                </div>
                <div id="food-candidates" class="space-y-4"></div>
            </div>

            <!-- Error Display -->
            <div id="error-area" class="hidden bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800 dark:text-red-200">
                            Analysis Failed
                        </h3>
                        <div id="error-message" class="mt-2 text-sm text-red-700 dark:text-red-300"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedFile = null;

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
}

function handleDrop(e) {
    e.preventDefault();
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFile(file) {
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showError('Please select an image file.');
        return;
    }
    
    // Validate file size (8MB limit)
    if (file.size > 8 * 1024 * 1024) {
        showError('File size must be less than 8MB.');
        return;
    }
    
    selectedFile = file;
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('preview-image').src = e.target.result;
        document.getElementById('upload-area').classList.add('hidden');
        document.getElementById('preview-area').classList.remove('hidden');
        hideError();
    };
    reader.readAsDataURL(file);
}

function clearPhoto() {
    selectedFile = null;
    document.getElementById('preview-area').classList.add('hidden');
    document.getElementById('upload-area').classList.remove('hidden');
    document.getElementById('results-area').classList.add('hidden');
    document.getElementById('photo-input').value = '';
    hideError();
}

function uploadPhoto() {
    if (!selectedFile) {
        showError('Please select a photo first.');
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', selectedFile);
    
    showLoading();
    hideError();
    
    fetch('/api/photo/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.candidates) {
            displayResults(data.candidates);
        } else {
            showError('No food items were identified in the photo. Try a clearer image with better lighting.');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Upload error:', error);
        showError('Photo analysis failed. Please try again or check your internet connection.');
    });
}

function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('results-area').classList.add('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

function displayResults(candidates) {
    const container = document.getElementById('food-candidates');
    
    if (!candidates || candidates.length === 0) {
        showError('No food items were identified. Try taking a clearer photo.');
        return;
    }
    
    container.innerHTML = candidates.map((candidate, index) => `
        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4" id="candidate-${index}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h5 class="font-medium text-gray-900 dark:text-gray-100">
                        ${candidate.name}
                    </h5>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Estimated portion: ${candidate.portion_grams}g | 
                        Confidence: ${Math.round(candidate.confidence * 100)}%
                        ${candidate.nutrition && candidate.nutrition.source ? ` | Source: ${candidate.nutrition.source}` : ''}
                    </div>
                    
                    ${candidate.nutrition ? `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 text-xs">
                            <div class="bg-red-100 dark:bg-red-900 px-2 py-1 rounded">
                                <strong>Calories:</strong> ${Math.round(candidate.nutrition.calories || 0)}
                            </div>
                            <div class="bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded">
                                <strong>Protein:</strong> ${(candidate.nutrition.protein_g || 0).toFixed(1)}g
                            </div>
                            <div class="bg-yellow-100 dark:bg-yellow-900 px-2 py-1 rounded">
                                <strong>Carbs:</strong> ${(candidate.nutrition.carbs_g || 0).toFixed(1)}g
                            </div>
                            <div class="bg-green-100 dark:bg-green-900 px-2 py-1 rounded">
                                <strong>Fat:</strong> ${(candidate.nutrition.fat_g || 0).toFixed(1)}g
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Meal selection inline -->
                    <div class="mt-4">
                        <label class="text-xs text-gray-600 dark:text-gray-400">Add to meal:</label>
                        <select id="meal-${index}" class="mt-1 block w-full text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                </div>
                
                <div class="ml-4 flex-shrink-0 space-y-2">
                    <button onclick="quickAddToLog(${index})" 
                            id="add-btn-${index}"
                            class="block w-full inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-plus mr-1"></i>
                        Quick Add
                    </button>
                    <button onclick="searchAndAdd(${index})" 
                            class="block w-full inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded text-white bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-search mr-1"></i>
                        Search & Add
                    </button>
                    <button onclick="editCandidate(${index})" 
                            class="block w-full inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-xs font-medium rounded text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-edit mr-1"></i>
                        Edit
                    </button>
                </div>
            </div>
            
            <!-- Status indicator -->
            <div id="status-${index}" class="mt-2 hidden"></div>
        </div>
    `).join('');
    
    // Set default meal time based on current time
    const now = new Date();
    const hour = now.getHours();
    let defaultMeal = 'snack';
    if (hour < 11) defaultMeal = 'breakfast';
    else if (hour < 16) defaultMeal = 'lunch';
    else if (hour < 21) defaultMeal = 'dinner';
    
    // Set default meal for all candidates
    candidates.forEach((_, index) => {
        document.getElementById(`meal-${index}`).value = defaultMeal;
    });
    
    document.getElementById('results-area').classList.remove('hidden');
    
    // Store candidates for later use
    window.photoAnalysisResults = candidates;
}

function quickAddToLog(index) {
    const candidate = window.photoAnalysisResults[index];
    const meal = document.getElementById(`meal-${index}`).value;
    const statusDiv = document.getElementById(`status-${index}`);
    const button = document.getElementById(`add-btn-${index}`);
    
    if (!candidate) return;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
    statusDiv.className = 'mt-2';
    statusDiv.innerHTML = '<div class="text-sm text-blue-600">Adding to food log...</div>';
    
    // Prepare data for API
    const logData = {
        custom_name: candidate.name,
        meal: meal,
        grams: candidate.portion_grams || 100,
        calories: Math.round(candidate.nutrition?.calories || 0),
        protein_g: candidate.nutrition?.protein_g || 0,
        carbs_g: candidate.nutrition?.carbs_g || 0,
        fat_g: candidate.nutrition?.fat_g || 0,
        fiber_g: candidate.nutrition?.fiber_g || 0,
        sugar_g: candidate.nutrition?.sugar_g || 0,
        sodium_mg: Math.round(candidate.nutrition?.sodium_mg || 0),
        source: 'photo_analysis'
    };
    
    // Send to API
    fetch('/api/logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(logData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Success
            statusDiv.innerHTML = `
                <div class="text-sm text-green-600 flex items-center">
                    <i class="fas fa-check mr-1"></i>
                    Added to ${meal} log!
                </div>
            `;
            button.innerHTML = '<i class="fas fa-check mr-1"></i>Added';
            button.className = button.className.replace('bg-green-600 hover:bg-green-700', 'bg-gray-400');
            button.disabled = true;
        } else {
            throw new Error(data.error || 'Failed to add food log');
        }
    })
    .catch(error => {
        console.error('Error adding to log:', error);
        statusDiv.innerHTML = `
            <div class="text-sm text-red-600 flex items-center">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Failed to add. Try again.
            </div>
        `;
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-plus mr-1"></i>Quick Add';
    });
}

function searchAndAdd(index) {
    const candidate = window.photoAnalysisResults[index];
    if (!candidate) return;
    
    // Pre-fill food search and redirect to search page
    const url = new URL('/search', window.location.origin);
    url.searchParams.set('q', candidate.name);
    url.searchParams.set('meal', document.getElementById(`meal-${index}`).value);
    url.searchParams.set('suggested_grams', candidate.portion_grams || 100);
    
    window.location.href = url.toString();
}

function addCandidateToLog(index) {
    const candidate = window.photoAnalysisResults[index];
    if (!candidate) return;
    
    // Pre-fill food logging form
    const url = new URL('/log', window.location.origin);
    url.searchParams.set('name', candidate.name);
    url.searchParams.set('grams', candidate.portion_grams);
    url.searchParams.set('meal', document.getElementById(`meal-${index}`).value);
    
    if (candidate.nutrition) {
        url.searchParams.set('calories', Math.round(candidate.nutrition.calories || 0));
        url.searchParams.set('protein', (candidate.nutrition.protein_g || 0).toFixed(1));
        url.searchParams.set('carbs', (candidate.nutrition.carbs_g || 0).toFixed(1));
        url.searchParams.set('fat', (candidate.nutrition.fat_g || 0).toFixed(1));
        url.searchParams.set('fiber', (candidate.nutrition.fiber_g || 0).toFixed(1));
        url.searchParams.set('sugar', (candidate.nutrition.sugar_g || 0).toFixed(1));
        url.searchParams.set('sodium', Math.round(candidate.nutrition.sodium_mg || 0));
    }
    
    window.location.href = url.toString();
}

function editCandidate(index) {
    // For now, redirect to manual logging with pre-filled data
    addCandidateToLog(index);
}

function quickAddAllToLog() {
    if (!window.photoAnalysisResults || window.photoAnalysisResults.length === 0) {
        showError('No food items to add.');
        return;
    }
    
    const addAllBtn = document.getElementById('add-all-btn');
    addAllBtn.disabled = true;
    addAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding All...';
    
    let completedCount = 0;
    let errorCount = 0;
    const totalCount = window.photoAnalysisResults.length;
    
    // Add each candidate
    window.photoAnalysisResults.forEach((candidate, index) => {
        const button = document.getElementById(`add-btn-${index}`);
        const statusDiv = document.getElementById(`status-${index}`);
        
        // Skip if already added
        if (button && button.disabled) {
            completedCount++;
            checkAllComplete();
            return;
        }
        
        const meal = document.getElementById(`meal-${index}`).value;
        
        // Show loading state
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
        }
        if (statusDiv) {
            statusDiv.className = 'mt-2';
            statusDiv.innerHTML = '<div class="text-sm text-blue-600">Adding to food log...</div>';
        }
        
        // Prepare data for API
        const logData = {
            custom_name: candidate.name,
            meal: meal,
            grams: candidate.portion_grams || 100,
            calories: Math.round(candidate.nutrition?.calories || 0),
            protein_g: candidate.nutrition?.protein_g || 0,
            carbs_g: candidate.nutrition?.carbs_g || 0,
            fat_g: candidate.nutrition?.fat_g || 0,
            fiber_g: candidate.nutrition?.fiber_g || 0,
            sugar_g: candidate.nutrition?.sugar_g || 0,
            sodium_mg: Math.round(candidate.nutrition?.sodium_mg || 0),
            source: 'photo_analysis'
        };
        
        // Send to API
        fetch('/api/logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(logData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Success
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="text-sm text-green-600 flex items-center">
                            <i class="fas fa-check mr-1"></i>
                            Added to ${meal} log!
                        </div>
                    `;
                }
                if (button) {
                    button.innerHTML = '<i class="fas fa-check mr-1"></i>Added';
                    button.className = button.className.replace('bg-green-600 hover:bg-green-700', 'bg-gray-400');
                }
                completedCount++;
            } else {
                throw new Error(data.error || 'Failed to add food log');
            }
        })
        .catch(error => {
            console.error('Error adding to log:', error);
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Failed to add.
                    </div>
                `;
            }
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plus mr-1"></i>Quick Add';
            }
            errorCount++;
            completedCount++;
        })
        .finally(() => {
            checkAllComplete();
        });
    });
    
    function checkAllComplete() {
        if (completedCount >= totalCount) {
            // All requests completed
            if (errorCount === 0) {
                addAllBtn.innerHTML = '<i class="fas fa-check mr-2"></i>All Added!';
                addAllBtn.className = addAllBtn.className.replace('bg-green-600 hover:bg-green-700', 'bg-gray-400');
                
                // Show success message
                setTimeout(() => {
                    showSuccess(`Successfully added all ${totalCount} food items to your log!`);
                }, 500);
            } else {
                addAllBtn.disabled = false;
                addAllBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Quick Add All';
                
                if (errorCount < totalCount) {
                    showSuccess(`Added ${totalCount - errorCount} out of ${totalCount} food items. ${errorCount} failed.`);
                } else {
                    showError('Failed to add any food items. Please try again.');
                }
            }
        }
    }
}

function showSuccess(message) {
    // Create a temporary success message
    const successDiv = document.createElement('div');
    successDiv.className = 'mt-4 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-md p-4';
    successDiv.innerHTML = `
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-green-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800 dark:text-green-200">
                    Success!
                </h3>
                <div class="mt-2 text-sm text-green-700 dark:text-green-300">
                    ${message}
                </div>
                <div class="mt-3">
                    <a href="/dashboard" class="text-sm font-medium text-green-800 dark:text-green-200 hover:text-green-600 dark:hover:text-green-400">
                        View Dashboard <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
    `;
    
    // Insert after results area
    const resultsArea = document.getElementById('results-area');
    resultsArea.parentNode.insertBefore(successDiv, resultsArea.nextSibling);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.parentNode.removeChild(successDiv);
        }
    }, 10000);
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-area').classList.remove('hidden');
}

function hideError() {
    document.getElementById('error-area').classList.add('hidden');
}
</script>
{% endblock %}